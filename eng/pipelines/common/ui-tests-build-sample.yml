steps:
  - template: provision.yml
    parameters:
      skipProvisioning:  ${{ eq(parameters.platform, 'windows') }}
      skipAndroidSdks: ${{ ne(parameters.platform, 'android') }}
      skipXcode: ${{ or(eq(parameters.platform, 'android'), eq(parameters.platform, 'windows')) }}
      provisionatorChannel: ${{ parameters.provisionatorChannel }}
  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: |
        defaults write -g NSAutomaticCapitalizationEnabled -bool false
        defaults write -g NSAutomaticTextCompletionEnabled -bool false
        defaults write -g NSAutomaticSpellingCorrectionEnabled -bool false
    displayName: "Modify defaults"
    continueOnError: true
  - pwsh: ./build.ps1 --target=dotnet --configuration="${{ parameters.configuration }}" --verbosity=diagnostic
    displayName: 'Install .NET'
    retryCountOnTaskFailure: 2
    env:
      DOTNET_TOKEN: $(dotnetbuilds-internal-container-read-token)
      PRIVATE_BUILD: $(PrivateBuild)

  - pwsh: echo "##vso[task.prependpath]$(DotNet.Dir)"
    displayName: 'Add .NET to PATH'

  - pwsh: ./build.ps1 --target=dotnet-buildtasks --configuration="${{ parameters.configuration }}"
    displayName: 'Build the MSBuild Tasks'

  - pwsh: ./build.ps1 --target=dotnet-samples --configuration="${{ parameters.configuration }}" --${{ parameters.platform }} --verbosity=diagnostic --usenuget=false
    displayName: 'Build the samples'

  - task: PublishBuildArtifacts@1
    condition: always()
    displayName: Publish artifacts